# VIPRPG 保存库实现方案

## 1. 整体架构
- **部署平台**：Vercel 上的静态输出（Next.js `app` 目录或 Astro 均可）。推荐使用 Next.js 14 + React Server Components，便于同构渲染与 i18n 扩展。
- **构建方式**：所有祭典与作品数据编译期读取 JSON，生成静态 HTML + 预渲染的 JSON。作品详情页使用静态路径生成（`generateStaticParams`）。
- **文件布局建议**：
  - `app/`：页面与布局，按年份/祭典划分子路由。
  - `components/`：通用 UI（折叠面板、作品列表、搜索框、Badge 等）。
  - `data/`：JSON 数据源；子目录分 `festivals/`、`works/`、`authors/`。
  - `public/`：静态资源（祭典 banner、作品封面、图标）。
  - `scripts/`：数据校验、构建工具脚本。

## 2. 数据模型设计
为保证可配置性与扩展性，约定统一 Schema，并在 CI 中用 JSON Schema 校验。

### 2.1 祭典列表（`data/festivals.json`）
```json
[
  {
    "id": "2024-summer",
    "year": 2024,
    "name": {
      "ja": "2024夏の陣",
      "zh": "2024夏之阵"
    },
    "slug": "2024-summer",
    "type": "summer",
    "banner": "/banners/2024-summer.png",
    "worksFile": "works/2024-summer.json",
    "columns": [
      "icon",
      "title",
      "category",
      "author",
      "engine",
      "streaming",
      "download",
      "forum"
    ],
    "metadata": {
      "host": "VIPRPG夏之阵",
      "period": "2024-08-01 ~ 2024-09-01"
    }
  }
]
```

### 2.2 作品列表（按祭典分文件，如 `data/works/2024-summer.json`）
```json
[
  {
    "id": "work-001",
    "festivalId": "2024-summer",
    "title": {
      "ja": "星の旅人",
      "zh": "星之旅人"
    },
    "icon": "/icons/2024-summer/work-001.png",
    "category": "RPG",
    "author": ["作者A", "作者B"],
    "engine": "RPGツクール2000",
    "streamingPolicy": "allow", // allow | restricted | forbid
    "download": {
      "mirrors": [
        {
          "name": "Primary",
          "url": "https://filehost.example.com/work-001/part-*.vip",
          "parts": 6,
          "checksum": "sha256-xxx"
        }
      ],
      "size": 87340000
    },
    "forum": "https://viprpg.example.com/thread/123",
    "description": {
      "ja": "",
      "zh": ""
    },
    "tags": ["冒险", "剧情"],
    "updates": [
      {
        "date": "2024-09-10",
        "note": "版本1.01修复存档问题"
      }
    ]
  }
]
```

### 2.3 作者/社团（可选）
单独 `data/authors.json` 存储作者别名、网站、社交链接，供作品详情聚合。

### 2.4 配置项说明
- `columns`：定义表格展示列，前端据此渲染；支持 `custom` 字段，用于在 JSON 中扩展。
- `streamingPolicy`：配合 UI 图标/提示文本，默认从字典映射。
- `download.mirrors.url` 支持 `*` 通配，以便前端生成分段链接。

## 3. 页面与交互实现

### 3.1 首页（/）
- 按年份分组渲染祭典；默认年份展开最新两个，其余折叠。
- 使用 `next/image`（或 Astro Image）对 banner 进行懒加载与响应式处理。
- 支持根据 URL Hash 定位到特定祭典（`#2024-summer`）。
- 结合 CSS Grid + Sticky Header 实现表格型展示。

### 3.2 作品列表折叠组件
- 实现一个可复用的 `FestivalPanel` 组件：
  - 首次展开时懒加载对应 JSON（`fetch('/works/2024-summer.json')`）。
  - 使用 `React.useTransition` 或 `suspense` 提升体验。
  - 加入虚拟滚动（如 `react-virtualized`）以应对长列表。

### 3.3 作品详情页（`/works/[id]`）
- 在构建期从所有作品 JSON 汇总生成静态路径。
- 页面包含：标题、元数据、允许直播说明、下载面板、版本更新记录、相关作品。
- 下载面板展示可用镜像、文件大小、校验值，并挂载“多线程合并下载”功能（见第 5 节）。
- 支持 `metadata` 生成 Open Graph/Twitter 卡片，便于分享。

### 3.4 搜索与过滤
- 编译期生成索引文件 `data/search-index.json`，内容为简化字段（标题、作者、标签、祭典）。
- 前端使用 `Fuse.js` 或 `MiniSearch` 进行模糊匹配，结果以高亮展示。
- 搜索结果支持快捷筛选（作品类型、允许直播状态）。

### 3.5 本地化（i18n）
- 使用 `next-intl` 或 `@lingui/core`：
  - 文案放置在 `locales/ja.json`、`locales/zh.json`。
  - 对于数据字段（如 `title`），优先读取当前语言，没有则回退到日语。
- URL 结构形如 `/ja/...`、`/zh/...`，默认 `/ja`。

## 4. 数据维护流程
- 所有 JSON 通过 `scripts/validate-data.ts` 校验（`ajv` + JSON Schema）。
- 在 PR / push 时运行 `pnpm lint:data` 验证结构、必填字段、链接可用性（HEAD 请求）。
- 提供 `scripts/sync-assets.ts`，根据 JSON 中引用的资源自动检查 `public/` 中是否存在对应文件。
- CI（GitHub Actions）在 `main` 分支构建后自动 `vercel deploy --prebuilt`。

## 5. 下载合并方案
- 限制：第三方文件床仅支持 20MB 单文件。
- 方案：
  1. 将原始文件预处理为 `*.vip.partNN` 分段，存储于文件床，并在 `download.mirrors` 中记录 `parts` 与校验值（每段 `sha256` + 汇总 `sha256`）。
  2. 前端使用 Service Worker + `ReadableStream` 并行拉取各段：
     - `Promise.all` 分段 `fetch`，利用 `AbortController` 控制超时。
     - 拉取后按序写入 `WritableStream`（借助 `streamSaver.js`）合成为单一文件。
  3. 同时生成一个备用的命令行脚本（`scripts/download-cli.mjs`），供用户在 Node.js 中运行：读取 JSON -> 并发下载 -> 合并 -> 校验。
  4. 下载面板提供“浏览器合并下载”与“命令行下载”两个入口，并展示校验指纹。
- 补充：若文件小于 20MB，可直接提供原始链接；前端根据 `parts` 字段判断 UI。

## 6. Vercel 优化
- 使用 Incremental Static Regeneration（`revalidate`）以便数据更新后按需刷新。
- 开启 `next.config.js` 的 `images.remotePatterns` 和 `headers()` 设置 CDN Cache-Control。
- 将 JSON 数据拆分为多个文件，避免单文件超过 Vercel 预览限制。
- 构建时通过 `pnpm build` 输出静态产物，借助 `@vercel/analytics` 监控访问量，及时监控免费额度。
- 若搜索索引较大，可按年份切分并懒加载。

## 7. 无障碍与 UI 细节
- 使用语义化标签（`<table>` + `<thead>/<tbody>`），并为折叠按钮增加 `aria-expanded`。
- 提供深浅色主题切换；banner 图片加替代文字说明。
- 列字段允许在前端切换可见性，满足不同用户的阅读习惯。

## 8. 开发栈与基础设施
- 包管理：`pnpm`
- 代码质量：`eslint` + `@typescript-eslint` + `prettier`
- 样式：`Tailwind CSS` 或 `Vanilla Extract`（任选一个保持一致）。
- UI 库：可以选择 Headless UI + 自定义样式，确保无障碍。
- 测试：
  - 组件测试：`vitest` + `@testing-library/react`
  - 端到端测试：`Playwright`（验证展开、搜索、下载流程）。
- 版本控制：在 `docs/` 目录维护 Schema 说明与贡献指南。

## 9. 实施里程碑
1. **MVP（2-3 周）**
   - 完成架构搭建、首页祭典折叠、作品详情页、基本 JSON 数据。
   - 实现基础下载链接展示（暂不合并）。
2. **功能完善（4-5 周）**
   - 加入搜索、过滤、i18n、Service Worker 下载合并。
   - 建立数据校验脚本与 CI。
3. **优化阶段（1-2 周）**
   - 性能调优（懒加载、虚拟列表）、SEO、OG 图。
   - 撰写贡献指南、编辑流程文档。

## 10. 后续拓展
- 引入作品点评或历史版本对比。
- 将下载脚本打包为可执行文件，方便 Windows 用户。
- 接入 S3/R2 等对象存储，减少对外部文件床依赖。
- 提供 API（静态 JSON）供第三方工具检索。

以上方案覆盖从数据结构定义、前端实现到下载合并与运维流程的细节，可作为实施 VIPRPG 保存库的基础蓝图。
